<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Extending ebnm with custom ebnm-style functions ‚Ä¢ ebnm</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Extending ebnm with custom ebnm-style functions">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">ebnm</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.1-38</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">Home</a>
</li>
<li>
  <a href="../articles/index.html">Vignettes</a>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/stephenslab/ebnm" class="external-link">Source</a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Extending ebnm with custom ebnm-style
functions</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/stephenslab/ebnm/blob/HEAD/vignettes/extending_ebnm.Rmd" class="external-link"><code>vignettes/extending_ebnm.Rmd</code></a></small>
      <div class="hidden name"><code>extending_ebnm.Rmd</code></div>

    </div>

    
    
<p>The <strong>ebnm</strong> package, in addition to providing
implementations of several commonly used priors (normal, Laplace, etc.),
was designed to be easily extensible so that researchers are not limited
by the existing options (despite the fact that a wide variety of options
are available!).</p>
<p>In this vignette, we illustrate how to extend <strong>ebnm</strong>
by creating a <em>custom EBNM solver</em> in the style of other
<strong>ebnm</strong> functions such as <code><a href="../reference/ebnm_normal.html">ebnm_normal()</a></code> and
<code><a href="../reference/ebnm_point_laplace.html">ebnm_point_laplace()</a></code>. Specifically, we implement an EBNM
solver, <code>ebnm_t()</code>, that uses the family of scaled
(Student‚Äôs) <em>t</em> priors. (As of this writing, this is not one of
the prior families included in <strong>ebnm</strong>.)</p>
<p><strong>Please note:</strong> This vignette assumes that you have
read the <a href="https://doi.org/10.18637/jss.v114.i03" class="external-link"><strong>ebnm</strong>
paper</a> and are familiar with the basic functionality of the
<strong>ebnm</strong> package.</p>
<div class="section level2">
<h2 id="the-scaled-t-prior-family">The scaled-<em>t</em> prior family<a class="anchor" aria-label="anchor" href="#the-scaled-t-prior-family"></a>
</h2>
<p>The <em>empirical Bayes normal means</em> (EBNM) model with
scaled-<em>t</em> prior is:</p>
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>x</mi><mi>i</mi></msub></mtd><mtd columnalign="left" style="text-align: left"><mo>‚àº</mo><mi>ùí©</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>Œ∏</mi><mi>i</mi></msub><mo>,</mo><msubsup><mi>s</mi><mi>i</mi><mn>2</mn></msubsup><mo stretchy="true" form="postfix">)</mo></mrow><mo>,</mo></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>Œ∏</mi><mi>i</mi></msub></mtd><mtd columnalign="left" style="text-align: left"><mo>‚àº</mo><mi>g</mi><mo>‚àà</mo><msub><mi>ùí¢</mi><mi>t</mi></msub><mi>.</mi></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}
x_i &amp;\sim \mathcal{N}(\theta_i, s_i^2), \\
\theta_i &amp;\sim g \in \mathcal{G}_t.
\end{aligned}</annotation></semantics></math><p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>ùí¢</mi><mi>t</mi></msub><annotation encoding="application/x-tex">\mathcal{G}_t</annotation></semantics></math>
is the family of scaled-<em>t</em> priors, defined as follows:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>ùí¢</mi><mi>t</mi></msub><mo>:=</mo><mo stretchy="false" form="prefix">{</mo><mi>g</mi><mo>:</mo><mi>g</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mi>œÉ</mi><msub><mi>t</mi><mi>ŒΩ</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>;</mo><mi>œÉ</mi><mo>&gt;</mo><mn>0</mn><mo>,</mo><mi>ŒΩ</mi><mo>&gt;</mo><mn>0</mn><mo stretchy="false" form="postfix">}</mo><mo>,</mo></mrow><annotation encoding="application/x-tex">\begin{equation}
\mathcal{G}_t := \{g: g(x) = \sigma t_{\nu}(x); \sigma &gt; 0, \nu &gt; 0\},
\end{equation}</annotation></semantics></math></p>
<p>where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>t</mi><mi>ŒΩ</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">t_{\nu}(x)</annotation></semantics></math>
denotes the density function of the <em>t</em> distribution at
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>x</mi><annotation encoding="application/x-tex">x</annotation></semantics></math>
with
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ŒΩ</mi><annotation encoding="application/x-tex">\nu</annotation></semantics></math>
degrees of freedom. Fitting the prior
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi><mo>‚àà</mo><msub><mi>ùí¢</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">g \in \mathcal{G}_t</annotation></semantics></math>
therefore involves estimating two parameters: the scale parameter
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>œÉ</mi><annotation encoding="application/x-tex">\sigma</annotation></semantics></math>
and the degrees of freedom
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ŒΩ</mi><annotation encoding="application/x-tex">\nu</annotation></semantics></math>.</p>
</div>
<div class="section level2">
<h2 id="overview-of-the-implementation-process">Overview of the implementation process<a class="anchor" aria-label="anchor" href="#overview-of-the-implementation-process"></a>
</h2>
<p>The <strong>ebnm</strong> package is intended to encompass a very
broad range of prior families. In general, creating a custom EBNM solver
involves the following steps:</p>
<ol style="list-style-type: decimal">
<li><p>Define the prior family class
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ùí¢</mi><annotation encoding="application/x-tex">\mathcal{G}</annotation></semantics></math>.</p></li>
<li><p>Implement a function that estimates the prior
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi><mo>‚àà</mo><mi>ùí¢</mi></mrow><annotation encoding="application/x-tex">g \in \mathcal{G}</annotation></semantics></math>.</p></li>
<li><p>Implement a function that computes summaries of the posteriors
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo>‚à£</mo><msub><mi>s</mi><mi>i</mi></msub><mo>,</mo><mover><mi>g</mi><mo accent="true">ÃÇ</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">p(x_i \mid s_i, \hat{g})</annotation></semantics></math>.</p></li>
<li><p>Create the main EBNM solver function.</p></li>
<li><p>Test the new EBNM solver.</p></li>
<li><p>Use the solver to analyze a data set.</p></li>
</ol>
<p>In the following sections, we work through each of these steps in
detail with the aim of creating a new function <code>ebnm_t()</code>
that can fit the EBNM model with scaled-<em>t</em> prior.</p>
<p>For readability, we advise adhering to the <a href="https://style.tidyverse.org" class="external-link">Tidyverse style guide</a>. Functions
should also be carefully tested; at minimum, functions should pass the
tests in <code><a href="../reference/ebnm_check_fn.html">ebnm_check_fn()</a></code>. Additional unit tests are
strongly encouraged. The <strong>ebnm</strong> package implements a
large suite of unit tests using the <a href="https://testthat.r-lib.org" class="external-link"><strong>testthat</strong>
package</a>.</p>
</div>
<div class="section level2">
<h2 id="step-1-define-the-prior-family-class">Step 1: Define the prior family class<a class="anchor" aria-label="anchor" href="#step-1-define-the-prior-family-class"></a>
</h2>
<p>First, we define a data structure for the priors in our prior family.
<strong>ebnm</strong> uses these structures in two ways: (1) to store
information about the fitted prior
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>g</mi><mo accent="true">ÃÇ</mo></mover><annotation encoding="application/x-tex">\hat{g}</annotation></semantics></math>
(via the <code>fitted_g</code> field in the returned <code>"ebnm"</code>
object); (2) to initialize solutions (via the <code>g_init</code>
argument).</p>
<!-- If one would like to be able to arbitrarily initialize the
solver, then the data structure should include all information
required to do so. -->
<!-- Note, however, that **ebnm** places no restrictions on data
structure since any initialization using `g_init` must be implemented
within the custom function itself. In particular, we could choose to
simply ignore `g_init` and return `fitted_g = NULL` (though this is
not recommended, since it gives no information about the fitted prior
$\hat{g} \in \mathcal{G}$). -->
<p>Sometimes, an existing data structure can be used. For example,
<code><a href="../reference/ebnm_normal.html">ebnm_normal()</a></code>, <code><a href="../reference/ebnm_point_normal.html">ebnm_point_normal()</a></code>,
<code><a href="../reference/ebnm_normal_scale_mixture.html">ebnm_normal_scale_mixture()</a></code>, and
<code><a href="../reference/ebnm_point_mass.html">ebnm_point_mass()</a></code> all share the <code>"normalmix"</code>
class. For the scaled-<em>t</em> prior, we define a new class,
<code>"tdist"</code>, that includes the scale and degrees of
freedom:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tdist</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">scale</span>, <span class="va">df</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/structure.html" class="external-link">structure</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">scale</span>, <span class="va">df</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"tdist"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="step-2-implement-the-optimization-function">Step 2: Implement the optimization function<a class="anchor" aria-label="anchor" href="#step-2-implement-the-optimization-function"></a>
</h2>
<p>Next we implement a function for estimating the two parameters
specifying the prior. Prior estimation is typically done by maximizing
the likelihood. There are many approaches one might take to solve this
optimization problem, and the best approach very much depends on
context. For an excellent overview of the many R packages that can be
used for numerical optimization, please see the <a href="https://CRAN.R-project.org/view=Optimization" class="external-link">CRAN task view on
optimization</a>.</p>
<p>Here, we use the L-BFGS-B method (implemented by the
<code><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim()</a></code> function). There are at least a couple of reasons
why we prefer using L-BFGS-B: (1) it doesn‚Äôt require installing any
additional packages; (2) it allows for bound constraints, which is
helpful since the two parameters in the prior both need to be positive.
Setting sensible upper and lower bounds can also help avoid numerical
issues. Here, we use the constraints
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mo>min</mo><mi>i</mi></msub><msub><mi>s</mi><mi>i</mi></msub><mi>/</mi><mn>10</mn><mo>‚â§</mo><mi>œÉ</mi><mo>‚â§</mo><msub><mo>max</mo><mi>i</mi></msub><msub><mi>x</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\min_i s_i / 10 \le \sigma \le \max_i x_i</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>‚â§</mo><mi>ŒΩ</mi><mo>‚â§</mo><mn>1000</mn></mrow><annotation encoding="application/x-tex">1 \le \nu \le 1000</annotation></semantics></math>:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">opt_t</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">x</span>, <span class="va">s</span>, <span class="va">sigma_init</span>, <span class="va">nu_init</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim</a></span><span class="op">(</span></span>
<span>    par <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">sigma_init</span>, <span class="va">nu_init</span><span class="op">)</span>, </span>
<span>    fn <span class="op">=</span> <span class="kw">function</span> <span class="op">(</span><span class="va">par</span><span class="op">)</span> <span class="op">-</span><span class="fu">llik_t</span><span class="op">(</span><span class="va">x</span>, <span class="va">s</span>, <span class="va">par</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">par</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>, </span>
<span>    method <span class="op">=</span> <span class="st">"L-BFGS-B"</span>,</span>
<span>    lower <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span><span class="op">/</span><span class="fl">10</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>    upper <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="fl">1e3</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Our optimization function <code>opt_t()</code> calls another
function, <code>llik_t()</code>, which isn‚Äôt yet implemented: this
function should give us the log likelihood at the current parameter
estimates. (Note that, since <code><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim()</a></code> seeks to minimize the
objective, we compute the negative log likelihood.)</p>
<p>Computing the log likelihood involves taking 1-d integrals, or
<em>1-d convolutions</em>, over the unknown means
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>Œ∏</mi><mi>i</mi></msub><annotation encoding="application/x-tex">\theta_i</annotation></semantics></math>:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>log</mo><mi>p</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>ùê±</mi><mo>‚à£</mo><mi>g</mi><mo>,</mo><mspace width="0.167em"></mspace><mi>ùê¨</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><munderover><mo>‚àë</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><mo>log</mo><mo>‚à´</mo><mi>p</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo>‚à£</mo><msub><mi>Œ∏</mi><mi>i</mi></msub><mo>,</mo><msub><mi>s</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mspace width="0.167em"></mspace><mi>g</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>Œ∏</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mspace width="0.167em"></mspace><mi>d</mi><msub><mi>Œ∏</mi><mi>i</mi></msub><mi>.</mi></mrow><annotation encoding="application/x-tex">\begin{equation}
\log p(\mathbf{x} \mid g, \, \mathbf{s}) = 
\sum_{i=1}^n \textstyle \log
\int p(x_i \mid \theta_i, s_i) \, g(\theta_i) \, d\theta_i.
\end{equation}</annotation></semantics></math></p>
<p>Since we do not have a convenient closed-form expression for these
integrals, we compute them numerically using the
<code><a href="https://rdrr.io/r/stats/integrate.html" class="external-link">integrate()</a></code> function:</p>
<!-- Inside the integral, we have the product of a normal distribution
and the prior, which in our case is a *t* distribution. -->
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">llik_t</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">x</span>, <span class="va">s</span>, <span class="va">sigma</span>, <span class="va">nu</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">lik_one_obs</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">x</span>, <span class="va">s</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/integrate.html" class="external-link">integrate</a></span><span class="op">(</span><span class="va">lik_times_prior</span>, <span class="op">-</span><span class="cn">Inf</span>, <span class="cn">Inf</span>, x <span class="op">=</span> <span class="va">x</span>, s <span class="op">=</span> <span class="va">s</span>,</span>
<span>              sigma <span class="op">=</span> <span class="va">sigma</span>, nu <span class="op">=</span> <span class="va">nu</span><span class="op">)</span><span class="op">$</span><span class="va">value</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">vlik</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Vectorize.html" class="external-link">Vectorize</a></span><span class="op">(</span><span class="va">lik_one_obs</span><span class="op">)</span> </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fu">vlik</span><span class="op">(</span><span class="va">x</span>, <span class="va">s</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lik_times_prior</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">theta</span>, <span class="va">x</span>, <span class="va">s</span>, <span class="va">sigma</span>, <span class="va">nu</span><span class="op">)</span> <span class="op">{</span></span>
<span>   <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">x</span> <span class="op">-</span> <span class="va">theta</span>, sd <span class="op">=</span> <span class="va">s</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/TDist.html" class="external-link">dt</a></span><span class="op">(</span><span class="va">theta</span> <span class="op">/</span> <span class="va">sigma</span>, df <span class="op">=</span> <span class="va">nu</span><span class="op">)</span> <span class="op">/</span> <span class="va">sigma</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="section level3">
<h3 id="optional-include-gradients-in-the-optimization">(Optional) Include gradients in the optimization<a class="anchor" aria-label="anchor" href="#optional-include-gradients-in-the-optimization"></a>
</h3>
<p>As we found empirically in our <a href="https://doi.org/10.18637/jss.v114.i03" class="external-link">numerical experiments</a>,
providing the gradient calculations to <code><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim()</a></code> can in some
cases greatly speed up the optimization. When implementing your own
custom EBNM solvers, you should consider providing gradients,
particularly when analytic expressions are available (either via pen and
paper or via automatic differentiation).</p>
<p>Gradients for the scaled-<em>t</em> priors turn out to be difficult
to obtain, but to illustrate how one might provide them, we estimate
gradients numerically using the <code><a href="https://rdrr.io/pkg/numDeriv/man/grad.html" class="external-link">grad()</a></code> function from the
<strong>numDeriv</strong> package. We include this code for illustrative
purposes; since <code><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim()</a></code> also computes gradients
numerically, we do not expect this solution to provide any speedup.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">opt_t</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">x</span>, <span class="va">s</span>, <span class="va">sigma_init</span>, <span class="va">nu_init</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim</a></span><span class="op">(</span></span>
<span>    par <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">sigma_init</span>, <span class="va">nu_init</span><span class="op">)</span>, </span>
<span>    fn <span class="op">=</span> <span class="kw">function</span> <span class="op">(</span><span class="va">par</span><span class="op">)</span> <span class="op">-</span><span class="fu">llik_t</span><span class="op">(</span><span class="va">x</span>, <span class="va">s</span>, <span class="va">par</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">par</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>, </span>
<span>    gr <span class="op">=</span> <span class="kw">function</span> <span class="op">(</span><span class="va">par</span><span class="op">)</span> <span class="op">-</span><span class="fu">grad_t</span><span class="op">(</span><span class="va">x</span>, <span class="va">s</span>, <span class="va">par</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">par</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>,</span>
<span>    method <span class="op">=</span> <span class="st">"L-BFGS-B"</span>,</span>
<span>    lower <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span><span class="op">/</span><span class="fl">10</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>    upper <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="fl">1e3</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>The <code>grad_t()</code> function used above will estimate the
gradients numerically using <strong>numDeriv</strong>:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://optimizer.r-forge.r-project.org/" class="external-link">numDeriv</a></span><span class="op">)</span></span>
<span><span class="va">grad_t</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">x</span>, <span class="va">s</span>, <span class="va">sigma</span>, <span class="va">nu</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/numDeriv/man/grad.html" class="external-link">grad</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">par</span><span class="op">)</span> <span class="fu">llik_t</span><span class="op">(</span><span class="va">x</span>, <span class="va">s</span>, <span class="va">par</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">par</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">sigma</span>, <span class="va">nu</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Using this version of the <code>opt_t</code> function should produce
very similar results to the implementation that does not include the
gradient.</p>
</div>
</div>
<div class="section level2">
<h2 id="step-3-implement-the-posterior-summary-function">Step 3: Implement the posterior summary function<a class="anchor" aria-label="anchor" href="#step-3-implement-the-posterior-summary-function"></a>
</h2>
<p>Once we‚Äôve estimated a prior
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover><mi>g</mi><mo accent="true">ÃÇ</mo></mover><mo>‚àà</mo><msub><mi>ùí¢</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">\hat{g} \in \mathcal{G}_t</annotation></semantics></math>,
we can compute summary statistics (means, variances, etc.) from the
posterior distributions.</p>
<p>From Bayes‚Äô rule, the posterior distribution for the <em>i</em>-th
unknown mean is</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>Œ∏</mi><mi>i</mi></msub><mo>‚à£</mo><msub><mi>x</mi><mi>i</mi></msub><mo>,</mo><msub><mi>s</mi><mi>i</mi></msub><mo>,</mo><mover><mi>g</mi><mo accent="true">ÃÇ</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow><mo>‚àù</mo><mi>p</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo>‚à£</mo><msub><mi>Œ∏</mi><mi>i</mi></msub><mo>,</mo><msub><mi>s</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mspace width="0.167em"></mspace><mover><mi>g</mi><mo accent="true">ÃÇ</mo></mover><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>Œ∏</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mi>.</mi></mrow><annotation encoding="application/x-tex">\begin{equation}
p(\theta_i \mid x_i, s_i, \hat{g}) \propto 
p(x_i \mid \theta_i, s_i) \, \hat{g}(\theta_i).
\end{equation}</annotation></semantics></math></p>
<p>For this example, we compute three posterior statistics: the
posterior mean, the posterior second moment, and the posterior standard
deviation. This is all accomplished by a single function that returns a
data frame containing the posterior statistics:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">post_summary_t</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">x</span>, <span class="va">s</span>, <span class="va">sigma</span>, <span class="va">nu</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">samp</span> <span class="op">&lt;-</span> <span class="fu">post_sampler_t</span><span class="op">(</span><span class="va">x</span>, <span class="va">s</span>, <span class="va">sigma</span>, <span class="va">nu</span>, nsamp <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">samp</span><span class="op">)</span>,</span>
<span>    sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">samp</span>, <span class="fl">2</span>, <span class="va">sd</span><span class="op">)</span>,</span>
<span>    second_moment <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">samp</span>, <span class="fl">2</span>, <span class="kw">function</span> <span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>The missing piece is a function <code>post_sampler_t()</code> that
draws random samples from the posteriors. While drawing independent
samples is difficult, we can easily design an MCMC scheme to
approximately draw samples from the posteriors. This is implemented
using the <strong>mcmc</strong> package (which you should install if you
haven‚Äôt already):</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># install.packages("mcmc")</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://www.stat.umn.edu/geyer/mcmc/" class="external-link">mcmc</a></span><span class="op">)</span></span>
<span><span class="va">post_sampler_t</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">x</span>, <span class="va">s</span>, <span class="va">sigma</span>, <span class="va">nu</span>, <span class="va">nsamp</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">sample_one_theta</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">x_i</span>, <span class="va">s_i</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">lpostdens</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">theta</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/stats/TDist.html" class="external-link">dt</a></span><span class="op">(</span><span class="va">theta</span><span class="op">/</span><span class="va">sigma</span>, df <span class="op">=</span> <span class="va">nu</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">-</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">sigma</span><span class="op">)</span> <span class="op">+</span> </span>
<span>        <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">x_i</span> <span class="op">-</span> <span class="va">theta</span>, sd <span class="op">=</span> <span class="va">s_i</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/mcmc/man/metrop.html" class="external-link">metrop</a></span><span class="op">(</span><span class="va">lpostdens</span>, initial <span class="op">=</span> <span class="va">x_i</span>, nbatch <span class="op">=</span> <span class="va">nsamp</span><span class="op">)</span><span class="op">$</span><span class="va">batch</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">vsampler</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Vectorize.html" class="external-link">Vectorize</a></span><span class="op">(</span><span class="va">sample_one_theta</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu">vsampler</span><span class="op">(</span><span class="va">x</span>, <span class="va">s</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>This is most certainly not the most efficient nor numerically stable
way to perform these computations. But we do it this way here to keep
the example simple.</p>
<!-- Given an optimal $\hat{g} \in \mathcal{G}$, we can obtain point
estimates for the "true means" $\theta_i$ using posterior means
$\mathbb{E}(\theta_i \mid x_i, s_i, \hat{g})$. In general, we might
like a number of summaries about the posterior,
including, for example, posterior standard deviations, second moments,
and local false sign rates [@Stephens_NewDeal]. If the EBNM solver is
intended for use in the **flashier** package, then posterior means and
second moments *must* be computed. -->
</div>
<div class="section level2">
<h2 id="step-4-put-it-all-together">Step 4: Put it all together<a class="anchor" aria-label="anchor" href="#step-4-put-it-all-together"></a>
</h2>
<p>Having implemented the key computations for our new EBNM solver, we
will now incorporate these computations into a single function,
<code>ebnm_t()</code>, which accepts the same inputs as the solvers in
the <strong>ebnm</strong> package.</p>
<!-- The inputs should be the same as the other **ebnm** functions. We
will also use the same defaults. We can ignore parameters that are not
relevant (here, `optmethod` and `control`). -->
<!-- The `optmethod` parameter can typically be ignored unless we
want to make multiple optimization methods available for a single
prior family (e.g., both `nlm()` and `optim()`). We will also ignore
the `control` parameter, although it could be used here, for example,
to alter the default settings of `lower` and `upper` in the call to
`optim`. -->
<p>For simplicity, we ignore the <code>output</code> parameter and just
return all the results (data, posterior summaries, fitted prior, log
likelihood and posterior sampler). See <code><a href="../reference/ebnm.html">help(ebnm)</a></code> for
details about the expected structure of the return value.</p>
<p>Here‚Äôs the new function:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ebnm_t</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">x</span>, </span>
<span>                    <span class="va">s</span> <span class="op">=</span> <span class="fl">1</span>, </span>
<span>                    <span class="va">mode</span> <span class="op">=</span> <span class="fl">0</span>, </span>
<span>                    <span class="va">scale</span> <span class="op">=</span> <span class="st">"estimate"</span>, </span>
<span>                    <span class="va">g_init</span> <span class="op">=</span> <span class="cn">NULL</span>, </span>
<span>                    <span class="va">fix_g</span> <span class="op">=</span> <span class="cn">FALSE</span>, </span>
<span>                    <span class="va">output</span> <span class="op">=</span> <span class="fu"><a href="../reference/ebnm.html">ebnm_output_default</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                    <span class="va">optmethod</span> <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                    <span class="va">control</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span></span>
<span>                   </span>
<span>  <span class="co"># Some basic argument checks.</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">mode</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"The mode of the t-prior must be fixed at zero."</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">scale</span> <span class="op">!=</span> <span class="st">"estimate"</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"The scale of the t-prior must be estimated rather than fixed "</span>,</span>
<span>         <span class="st">"at a particular value."</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># If g_init is provided, extract the parameters. Otherwise, provide</span></span>
<span>  <span class="co"># reasonable initial estimates.</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">g_init</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">sigma_init</span> <span class="op">&lt;-</span> <span class="va">g_init</span><span class="op">$</span><span class="va">scale</span></span>
<span>    <span class="va">nu_init</span>    <span class="op">&lt;-</span> <span class="va">g_init</span><span class="op">$</span><span class="va">df</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">sigma_init</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">nu_init</span>    <span class="op">&lt;-</span> <span class="fl">4</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># If g is fixed, use g_init. Otherwise optimize g.</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">fix_g</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">sigma</span> <span class="op">&lt;-</span> <span class="va">sigma_init</span></span>
<span>    <span class="va">nu</span>    <span class="op">&lt;-</span> <span class="va">nu_init</span></span>
<span>    <span class="va">llik</span>  <span class="op">&lt;-</span> <span class="fu">llik_t</span><span class="op">(</span><span class="va">x</span>, <span class="va">s</span>, <span class="va">sigma</span>, <span class="va">nu</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">opt_res</span> <span class="op">&lt;-</span> <span class="fu">opt_t</span><span class="op">(</span><span class="va">x</span>, <span class="va">s</span>, <span class="va">sigma_init</span>, <span class="va">nu_init</span><span class="op">)</span></span>
<span>    <span class="va">sigma</span>   <span class="op">&lt;-</span> <span class="va">opt_res</span><span class="op">$</span><span class="va">par</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span>    <span class="va">nu</span>      <span class="op">&lt;-</span> <span class="va">opt_res</span><span class="op">$</span><span class="va">par</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span>    <span class="va">llik</span>    <span class="op">&lt;-</span> <span class="op">-</span><span class="va">opt_res</span><span class="op">$</span><span class="va">value</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># Prepare the final output.</span></span>
<span>  <span class="va">retval</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/structure.html" class="external-link">structure</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, s <span class="op">=</span> <span class="va">s</span><span class="op">)</span>,</span>
<span>    posterior <span class="op">=</span> <span class="fu">post_summary_t</span><span class="op">(</span><span class="va">x</span>, <span class="va">s</span>, <span class="va">sigma</span>, <span class="va">nu</span><span class="op">)</span>,</span>
<span>    fitted_g <span class="op">=</span> <span class="fu">tdist</span><span class="op">(</span>scale <span class="op">=</span> <span class="va">sigma</span>, df <span class="op">=</span> <span class="va">nu</span><span class="op">)</span>,</span>
<span>    log_likelihood <span class="op">=</span> <span class="va">llik</span>,</span>
<span>    post_sampler <span class="op">=</span> <span class="kw">function</span> <span class="op">(</span><span class="va">nsamp</span><span class="op">)</span> <span class="fu">post_sampler_t</span><span class="op">(</span><span class="va">x</span>, <span class="va">s</span>, <span class="va">sigma</span>, <span class="va">nu</span>, <span class="va">nsamp</span><span class="op">)</span></span>
<span>  <span class="op">)</span>, class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"list"</span>, <span class="st">"ebnm"</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">retval</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="step-5-verify-the-ebnm-function">Step 5: Verify the EBNM function<a class="anchor" aria-label="anchor" href="#step-5-verify-the-ebnm-function"></a>
</h2>
<p><strong>ebnm</strong> provides a function,
<code><a href="../reference/ebnm_check_fn.html">ebnm_check_fn()</a></code>, that runs basic tests to verify that the
EBNM function works as expected. Let‚Äôs run the checks using a small,
simulated data set:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/stephenslab/ebnm" class="external-link">ebnm</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">10</span>, sd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">10</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/ebnm_check_fn.html">ebnm_check_fn</a></span><span class="op">(</span><span class="va">ebnm_t</span>, <span class="va">x</span>, <span class="va">s</span><span class="op">)</span></span>
<span><span class="co"># Function has passed all checks.</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="step-6-use-the-new-ebnm-function-to-analyze-a-data-set">Step 6: Use the new EBNM function to analyze a data set<a class="anchor" aria-label="anchor" href="#step-6-use-the-new-ebnm-function-to-analyze-a-data-set"></a>
</h2>
<p>Finally, we analyze a simulated data set in which the unobserved
means are simulated from a <em>t</em> distribution with a scale of 2 and
5 degrees of freedom:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">theta</span> <span class="op">&lt;-</span> <span class="fl">2</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/TDist.html" class="external-link">rt</a></span><span class="op">(</span><span class="fl">100</span>, df <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="va">theta</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span></span></code></pre></div>
<p>Let‚Äôs compare the use of the scaled-<em>t</em> prior with a normal
prior:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">normal_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ebnm_normal.html">ebnm_normal</a></span><span class="op">(</span><span class="va">x</span>, s <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">t_res</span> <span class="op">&lt;-</span> <span class="fu">ebnm_t</span><span class="op">(</span><span class="va">x</span>, s <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p>(Note that the call to <code>ebnm_t()</code> is considerably slower
than the call to <code><a href="../reference/ebnm_normal.html">ebnm_normal()</a></code> because the computations
with the scaled-<em>t</em> prior are more complex and we did not put any
effort into making the computations efficient.)</p>
<p>Let‚Äôs compare the two results:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">normal_res</span>, <span class="va">t_res</span><span class="op">)</span></span></code></pre></div>
<p><img src="extending_ebnm_files/figure-html/plot-t-vs-normal-1.png" width="540" style="display: block; margin: auto;"></p>
<p><code>ebnm_t()</code> shrinks large observations less aggressively
than <code><a href="../reference/ebnm_normal.html">ebnm_normal()</a></code> and so the fit with the
scaled-<em>t</em> prior results in slightly more accurate estimates:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rmse_normal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">normal_res</span><span class="op">)</span> <span class="op">-</span> <span class="va">theta</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">rmse_t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">t_res</span><span class="op">)</span> <span class="op">-</span> <span class="va">theta</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>rmse_normal <span class="op">=</span> <span class="va">rmse_normal</span>, rmse_t <span class="op">=</span> <span class="va">rmse_t</span><span class="op">)</span></span>
<span><span class="co"># rmse_normal      rmse_t </span></span>
<span><span class="co">#   0.9056053   0.8662794</span></span></code></pre></div>
<p>Reassuringly, the parameters of the estimated prior are similar to
the simulation parameters
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>œÉ</mi><mo>=</mo><mn>2</mn></mrow><annotation encoding="application/x-tex">\sigma = 2</annotation></semantics></math>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ŒΩ</mi><mo>=</mo><mn>5</mn></mrow><annotation encoding="application/x-tex">\nu = 5</annotation></semantics></math>):</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">t_res</span><span class="op">$</span><span class="va">fitted_g</span><span class="op">)</span></span>
<span><span class="co"># $scale</span></span>
<span><span class="co"># [1] 1.785927</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># $df</span></span>
<span><span class="co"># [1] 4.456856</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="session-information">Session information<a class="anchor" aria-label="anchor" href="#session-information"></a>
</h2>
<p>The following R version and packages were used to generate this
vignette:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html" class="external-link">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># R version 4.5.1 (2025-06-13)</span></span>
<span><span class="co"># Platform: aarch64-apple-darwin20</span></span>
<span><span class="co"># Running under: macOS Sequoia 15.5</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Matrix products: default</span></span>
<span><span class="co"># BLAS:   /Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/lib/libRblas.0.dylib </span></span>
<span><span class="co"># LAPACK: /Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.12.1</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># locale:</span></span>
<span><span class="co"># [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># time zone: America/New_York</span></span>
<span><span class="co"># tzcode source: internal</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># attached base packages:</span></span>
<span><span class="co"># [1] stats     graphics  grDevices utils     datasets  methods   base     </span></span>
<span><span class="co"># </span></span>
<span><span class="co"># other attached packages:</span></span>
<span><span class="co"># [1] ebnm_1.1-38 mcmc_0.9-8 </span></span>
<span><span class="co"># </span></span>
<span><span class="co"># loaded via a namespace (and not attached):</span></span>
<span><span class="co">#  [1] sass_0.4.10        generics_0.1.4     ashr_2.2-63        lattice_0.22-7    </span></span>
<span><span class="co">#  [5] digest_0.6.37      magrittr_2.0.3     evaluate_1.0.4     grid_4.5.1        </span></span>
<span><span class="co">#  [9] RColorBrewer_1.1-3 fastmap_1.2.0      jsonlite_2.0.0     Matrix_1.7-3      </span></span>
<span><span class="co"># [13] mixsqp_0.3-54      scales_1.4.0       truncnorm_1.0-9    invgamma_1.2      </span></span>
<span><span class="co"># [17] textshaping_1.0.1  jquerylib_0.1.4    cli_3.6.5          rlang_1.1.6       </span></span>
<span><span class="co"># [21] deconvolveR_1.2-1  splines_4.5.1      withr_3.0.2        cachem_1.1.0      </span></span>
<span><span class="co"># [25] yaml_2.3.10        tools_4.5.1        SQUAREM_2021.1     dplyr_1.1.4       </span></span>
<span><span class="co"># [29] ggplot2_3.5.2      vctrs_0.6.5        R6_2.6.1           lifecycle_1.0.4   </span></span>
<span><span class="co"># [33] fs_1.6.6           htmlwidgets_1.6.4  trust_0.1-8        ragg_1.4.0        </span></span>
<span><span class="co"># [37] irlba_2.3.5.1      pkgconfig_2.0.3    desc_1.4.3         pkgdown_2.1.3     </span></span>
<span><span class="co"># [41] bslib_0.9.0        pillar_1.11.0      gtable_0.3.6       glue_1.8.0        </span></span>
<span><span class="co"># [45] Rcpp_1.1.0         systemfonts_1.2.3  xfun_0.52          tibble_3.3.0      </span></span>
<span><span class="co"># [49] tidyselect_1.2.1   rstudioapi_0.17.1  knitr_1.50         farver_2.1.2      </span></span>
<span><span class="co"># [53] htmltools_0.5.8.1  labeling_0.4.3     rmarkdown_2.29     compiler_4.5.1    </span></span>
<span><span class="co"># [57] horseshoe_0.2.0</span></span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Jason Willwerscheid, Matthew Stephens, Peter Carbonetto.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

      </footer>
</div>






  </body>
</html>
